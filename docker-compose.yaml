version: "3.9"

networks:
  app-tier:
    driver: bridge

services:
  zookeeper:
    container_name: zookeeper
    image: zookeeper
    ports:
      - "2181:2181"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
    restart: unless-stopped
    networks:
      - app-tier

  kafka:
    container_name: kafka
    image: 'bitnami/kafka:latest'
    networks:
      - app-tier
    healthcheck:
      test: ["CMD", "bash", "-c", "unset" , "JMX_PORT" ,";" ,"kafka-topics.sh","--zookeeper","zookeeper:2181","--list"]
    environment:
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CREATE_TOPICS=sensors:1:1
      - KAFKA_LOG_RETENTION_HOURS=1
      - KAFKA_LOG_RETENTION_BYTES=4073741824
      - KAFKA_LOG_SEGMENT_BYTES=1073741824
      - KAFKA_RETENTION_CHECK_INTERVAL_MS=300000
    ports:
      - '9092:9092'
    depends_on:
      - zookeeper

  akhq:
    container_name: akhq
    image: tchiotludo/akhq:latest
    ports:
      - "8080:8080"
    environment:
      AKHQ_CONFIGURATION: |
        akhq:
          connections:
            sensors-simulation:
              properties:
                bootstrap.servers: kafka:9092
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - app-tier

  simulator:
    container_name: simulator
    build:
      context: ./simulator
      dockerfile: Dockerfile
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - app-tier

